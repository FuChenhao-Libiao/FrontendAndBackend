<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤è®°å½• - äººè„¸ç­¾åˆ°è€ƒå‹¤ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar .logo span {
            margin-right: 10px;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar .nav-links a {
            text-decoration: none;
            color: #666;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .navbar .nav-links a:hover,
        .navbar .nav-links a.active {
            background: #667eea;
            color: white;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .stat-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }

        .stat-card .label {
            color: #999;
            margin-top: 5px;
        }

        .stat-card.primary { border-top: 4px solid #667eea; }
        .stat-card.success { border-top: 4px solid #4caf50; }
        .stat-card.warning { border-top: 4px solid #ff9800; }
        .stat-card.info { border-top: 4px solid #2196f3; }
        .stat-card.danger { border-top: 4px solid #f44336; }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            color: #666;
            font-weight: bold;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .employee-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .employee-info .name {
            font-weight: bold;
        }

        .employee-info .id {
            font-size: 12px;
            color: #999;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .status-badge.normal {
            background: #e8f5e9;
            color: #4caf50;
        }

        .status-badge.late {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-badge.early {
            background: #e3f2fd;
            color: #2196f3;
        }

        .status-badge.absent {
            background: #ffebee;
            color: #f44336;
        }

        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: #666;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .empty-state .title {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        /* åŠ è½½ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }

        /* å¿«é€Ÿç­›é€‰ */
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-filter {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-filter:hover,
        .quick-filter.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <span>ğŸ­</span>äººè„¸ç­¾åˆ°è€ƒå‹¤ç³»ç»Ÿ
        </div>
        <div class="nav-links">
            <a href="index.html">ğŸ“· ç­¾åˆ°æ‰“å¡</a>
            <a href="register.html">ğŸ‘¤ äººè„¸æ³¨å†Œ</a>
            <a href="records.html" class="active">ğŸ“‹ è€ƒå‹¤è®°å½•</a>
            <a href="admin.html">âš™ï¸ ç®¡ç†åå°</a>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">ğŸ‘¥</div>
                <div class="value" id="statTotal">0</div>
                <div class="label">ä»Šæ—¥åº”åˆ°</div>
            </div>
            <div class="stat-card success">
                <div class="icon">âœ…</div>
                <div class="value" id="statCheckedIn">0</div>
                <div class="label">å·²ç­¾åˆ°</div>
            </div>
            <div class="stat-card warning">
                <div class="icon">â°</div>
                <div class="value" id="statLate">0</div>
                <div class="label">è¿Ÿåˆ°</div>
            </div>
            <div class="stat-card info">
                <div class="icon">ğŸƒ</div>
                <div class="value" id="statEarly">0</div>
                <div class="label">æ—©é€€</div>
            </div>
            <div class="stat-card danger">
                <div class="icon">âŒ</div>
                <div class="value" id="statAbsent">0</div>
                <div class="label">ç¼ºå‹¤</div>
            </div>
        </div>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ” ç­›é€‰æ¡ä»¶</h2>
            
            <div class="quick-filters">
                <button class="quick-filter active" onclick="setQuickFilter('today')">ä»Šå¤©</button>
                <button class="quick-filter" onclick="setQuickFilter('week')">æœ¬å‘¨</button>
                <button class="quick-filter" onclick="setQuickFilter('month')">æœ¬æœˆ</button>
                <button class="quick-filter" onclick="setQuickFilter('custom')">è‡ªå®šä¹‰</button>
            </div>

            <div class="filter-section">
                <div class="filter-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <label>å‘˜å·¥å·¥å·</label>
                    <input type="text" id="employeeId" placeholder="è¾“å…¥å·¥å·">
                </div>
                <div class="filter-group">
                    <label>éƒ¨é—¨</label>
                    <select id="department">
                        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>çŠ¶æ€</label>
                    <select id="status">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="æ­£å¸¸">æ­£å¸¸</option>
                        <option value="è¿Ÿåˆ°">è¿Ÿåˆ°</option>
                        <option value="æ—©é€€">æ—©é€€</option>
                        <option value="ç¼ºå‹¤">ç¼ºå‹¤</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="searchRecords()">ğŸ” æŸ¥è¯¢</button>
                <button class="btn btn-secondary" onclick="resetFilters()">â†» é‡ç½®</button>
                <button class="btn btn-success" onclick="exportRecords()">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>

        <!-- è®°å½•åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“‹ è€ƒå‹¤è®°å½•</h2>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‘˜å·¥</th>
                            <th>éƒ¨é—¨</th>
                            <th>æ—¥æœŸ</th>
                            <th>ç­¾åˆ°æ—¶é—´</th>
                            <th>ç­¾é€€æ—¶é—´</th>
                            <th>å·¥ä½œæ—¶é•¿</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="icon">ğŸ“­</div>
                <div class="title">æš‚æ— è€ƒå‹¤è®°å½•</div>
                <div>è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶é‡è¯•</div>
            </div>

            <div class="pagination" id="pagination">
                <button onclick="prevPage()" id="btnPrev">â† ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                <button onclick="nextPage()" id="btnNext">ä¸‹ä¸€é¡µ â†’</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="js/api.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let currentFilter = 'today';

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            initDates();
            loadDepartments();
            loadStatistics();
            searchRecords();
        });

        // åˆå§‹åŒ–æ—¥æœŸ
        function initDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        }

        // è®¾ç½®å¿«é€Ÿç­›é€‰
        function setQuickFilter(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.quick-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // è®¡ç®—æ—¥æœŸ
            const today = new Date();
            let startDate, endDate;

            switch (filter) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay() + 1);
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'custom':
                    return; // ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
            }

            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            
            currentPage = 1;
            searchRecords();
        }

        // åŠ è½½éƒ¨é—¨åˆ—è¡¨
        async function loadDepartments() {
            try {
                const response = await api.getEmployees();
                if (response.success) {
                    const departments = [...new Set(response.data.list.map(e => e.department).filter(d => d))];
                    const select = document.getElementById('department');
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½éƒ¨é—¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await api.getTodayStats();
                if (response.success) {
                    document.getElementById('statTotal').textContent = response.data.totalEmployees || 0;
                    document.getElementById('statCheckedIn').textContent = response.data.checkedIn || 0;
                    document.getElementById('statLate').textContent = response.data.lateCount || 0;
                    document.getElementById('statEarly').textContent = response.data.earlyCount || 0;
                    document.getElementById('statAbsent').textContent = response.data.notCheckedIn || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æŸ¥è¯¢è®°å½•
        async function searchRecords() {
            showLoading();

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = {
                startDate: startDate,
                endDate: endDate,
                employeeId: document.getElementById('employeeId').value,
                department: document.getElementById('department').value,
                status: document.getElementById('status').value,
                includeAbsent: startDate === endDate ? 'true' : '',  // å•æ—¥æŸ¥è¯¢æ—¶åŒ…å«ç¼ºå‹¤
                page: currentPage,
                size: pageSize
            };

            try {
                const response = await api.getAttendanceRecords(params);
                hideLoading();

                if (response.success) {
                    renderRecords(response.data);
                    updatePagination(response.data);
                } else {
                    showToast(response.message, 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“è®°å½•
        function renderRecords(data) {
            const tbody = document.getElementById('recordsBody');
            const emptyState = document.getElementById('emptyState');
            const records = data.list || [];

            if (records.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('pagination').style.display = 'flex';

            tbody.innerHTML = records.map(record => {
                // æ„å»ºçŠ¶æ€æ˜¾ç¤º
                let statusHtml = '';
                if (record.checkInStatus) {
                    statusHtml += `<span class="status-badge ${getStatusClass(record.checkInStatus)}">${record.checkInStatus}</span>`;
                }
                if (record.checkOutStatus) {
                    statusHtml += `<span class="status-badge ${getStatusClass(record.checkOutStatus)}">${record.checkOutStatus}</span>`;
                }
                if (!statusHtml) {
                    statusHtml = '<span class="status-badge normal">æ­£å¸¸</span>';
                }
                
                return `
                <tr>
                    <td>
                        <div class="employee-cell">
                            <div class="employee-avatar">${record.name.charAt(0)}</div>
                            <div class="employee-info">
                                <div class="name">${record.name}</div>
                                <div class="id">${record.employeeId}</div>
                            </div>
                        </div>
                    </td>
                    <td>${record.department || '-'}</td>
                    <td>${record.date}</td>
                    <td>${record.checkInTime || '--:--'}</td>
                    <td>${record.checkOutTime || '--:--'}</td>
                    <td>${record.workHours || '-'}</td>
                    <td>${statusHtml}</td>
                </tr>
            `}).join('');
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'æ­£å¸¸': return 'normal';
                case 'è¿Ÿåˆ°': return 'late';
                case 'æ—©é€€': return 'early';
                case 'ç¼ºå‹¤': return 'absent';
                default: return '';
            }
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(data) {
            totalPages = Math.ceil((data.total || 0) / pageSize) || 1;
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
            document.getElementById('btnPrev').disabled = currentPage <= 1;
            document.getElementById('btnNext').disabled = currentPage >= totalPages;
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                searchRecords();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                searchRecords();
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('employeeId').value = '';
            document.getElementById('department').value = '';
            document.getElementById('status').value = '';
            setQuickFilter('today');
        }

        // å¯¼å‡ºè®°å½•
        async function exportRecords() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showToast('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´', 'warning');
                return;
            }

            showToast('æ­£åœ¨å¯¼å‡º...', 'success');

            try {
                await api.exportRecords(startDate, endDate);
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºåŠ è½½
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        // éšè—åŠ è½½
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
