<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸æ³¨å†Œ - äººè„¸ç­¾åˆ°è€ƒå‹¤ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar .logo span {
            margin-right: 10px;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar .nav-links a {
            text-decoration: none;
            color: #666;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .navbar .nav-links a:hover,
        .navbar .nav-links a.active {
            background: #667eea;
            color: white;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        /* æ³¨å†ŒåŒºåŸŸ */
        .register-section {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .register-section {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps {
            display: flex;
            margin-bottom: 25px;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ddd;
        }

        .step:last-child::after {
            display: none;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .step.active .step-number {
            background: #667eea;
        }

        .step.completed .step-number {
            background: #4caf50;
        }

        .step-label {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        /* å‘˜å·¥ä¿¡æ¯è¡¨å• */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group .hint {
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }

        /* æ‘„åƒå¤´åŒºåŸŸ */
        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #1a1a2e;
            border-radius: 12px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .face-guide {
            width: 180px;
            height: 230px;
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        .camera-status {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 1.5s infinite;
        }

        .status-dot.error {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ç…§ç‰‡é¢„è§ˆ */
        .photos-preview {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .photo-item {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid #ddd;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-placeholder {
            width: 80px;
            height: 80px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* å‘˜å·¥é€‰æ‹© */
        .employee-select {
            margin-bottom: 20px;
        }

        .employee-search {
            position: relative;
        }

        .employee-search input {
            width: 100%;
            padding: 12px 15px;
            padding-left: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .employee-search .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .employee-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }

        .employee-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .employee-option:hover {
            background: #f5f5f5;
        }

        .employee-option.selected {
            background: #e3f2fd;
        }

        .employee-option .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .employee-option .info .name {
            font-weight: bold;
        }

        .employee-option .info .dept {
            font-size: 13px;
            color: #999;
        }

        .employee-option .face-status {
            margin-left: auto;
            font-size: 13px;
        }

        .employee-option .face-status.registered {
            color: #4caf50;
        }

        .employee-option .face-status.not-registered {
            color: #ff9800;
        }

        /* æ³¨å†Œå®Œæˆ */
        .register-complete {
            text-align: center;
            padding: 40px 20px;
        }

        .register-complete .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .register-complete .title {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 10px;
        }

        .register-complete .message {
            color: #666;
            margin-bottom: 30px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        /* æç¤ºä¿¡æ¯ */
        .tips-card {
            background: linear-gradient(135deg, #fff9c4, #fff59d);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .tips-card h3 {
            color: #f57f17;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-card ul {
            list-style: none;
            color: #5d4037;
        }

        .tips-card li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .tips-card li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <span>ğŸ­</span>äººè„¸ç­¾åˆ°è€ƒå‹¤ç³»ç»Ÿ
        </div>
        <div class="nav-links">
            <a href="index.html">ğŸ“· ç­¾åˆ°æ‰“å¡</a>
            <a href="register.html" class="active">ğŸ‘¤ äººè„¸æ³¨å†Œ</a>
            <a href="records.html">ğŸ“‹ è€ƒå‹¤è®°å½•</a>
            <a href="admin.html">âš™ï¸ ç®¡ç†åå°</a>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">é€‰æ‹©å‘˜å·¥</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">é‡‡é›†äººè„¸</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">å®Œæˆæ³¨å†Œ</div>
                </div>
            </div>
        </div>

        <div class="register-section">
            <!-- å·¦ä¾§ï¼šä¸»è¦å†…å®¹åŒº -->
            <div class="card">
                <!-- æ­¥éª¤1ï¼šé€‰æ‹©å‘˜å·¥ -->
                <div id="stepContent1">
                    <h2>ğŸ‘¤ é€‰æ‹©å‘˜å·¥</h2>
                    
                    <div class="employee-select">
                        <div class="employee-search">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" id="searchEmployee" placeholder="æœç´¢å‘˜å·¥å·¥å·æˆ–å§“å..." oninput="filterEmployees()">
                        </div>
                        <div class="employee-list" id="employeeList">
                            <!-- å‘˜å·¥åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <div style="text-align: center; color: #999; margin: 20px 0;">
                        â€” æˆ–è€… â€”
                    </div>

                    <h3 style="margin-bottom: 15px;">æ·»åŠ æ–°å‘˜å·¥</h3>
                    <div class="form-group">
                        <label for="newEmployeeId">å·¥å· *</label>
                        <input type="text" id="newEmployeeId" placeholder="è¯·è¾“å…¥å·¥å·">
                    </div>
                    <div class="form-group">
                        <label for="newEmployeeName">å§“å *</label>
                        <input type="text" id="newEmployeeName" placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label for="newDepartment">éƒ¨é—¨</label>
                        <input type="text" id="newDepartment" placeholder="è¯·è¾“å…¥éƒ¨é—¨ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label for="newPosition">èŒä½</label>
                        <input type="text" id="newPosition" placeholder="è¯·è¾“å…¥èŒä½ï¼ˆå¯é€‰ï¼‰">
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="goToStep2()">ä¸‹ä¸€æ­¥ï¼šé‡‡é›†äººè„¸ â†’</button>
                    </div>
                </div>

                <!-- æ­¥éª¤2ï¼šé‡‡é›†äººè„¸ -->
                <div id="stepContent2" style="display: none;">
                    <h2>ğŸ“· é‡‡é›†äººè„¸ç…§ç‰‡</h2>
                    
                    <div id="selectedEmployee" style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>å½“å‰å‘˜å·¥ï¼š</strong><span id="currentEmployeeName">-</span>
                        <span style="margin-left: 10px; color: #666;">å·¥å·ï¼š<span id="currentEmployeeId">-</span></span>
                    </div>

                    <div class="camera-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <div class="camera-overlay">
                            <div class="face-guide"></div>
                        </div>
                        <div class="camera-status">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="statusText">æ‘„åƒå¤´å°±ç»ª</span>
                        </div>
                    </div>

                    <p style="text-align: center; color: #666; margin-top: 15px;">
                        è¯·æ‹æ‘„ <strong>3å¼ </strong> ä¸åŒè§’åº¦çš„ç…§ç‰‡ï¼ˆæ­£é¢ã€å·¦ä¾§ã€å³ä¾§ï¼‰
                    </p>

                    <div class="photos-preview" id="photosPreview">
                        <div class="photo-placeholder">+</div>
                        <div class="photo-placeholder">+</div>
                        <div class="photo-placeholder">+</div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep1()">â† ä¸Šä¸€æ­¥</button>
                        <button class="btn btn-primary" onclick="capturePhoto()" id="btnCapture">ğŸ“· æ‹ç…§</button>
                        <button class="btn btn-success" onclick="submitRegister()" id="btnSubmit" disabled>ç¡®è®¤æ³¨å†Œ âœ“</button>
                    </div>
                </div>

                <!-- æ­¥éª¤3ï¼šå®Œæˆæ³¨å†Œ -->
                <div id="stepContent3" style="display: none;">
                    <div class="register-complete">
                        <div class="icon">ğŸ‰</div>
                        <div class="title">äººè„¸æ³¨å†ŒæˆåŠŸï¼</div>
                        <div class="message">
                            å‘˜å·¥ <strong id="completeName">-</strong> çš„äººè„¸å·²æˆåŠŸæ³¨å†Œ<br>
                            ç°åœ¨å¯ä»¥ä½¿ç”¨äººè„¸è¿›è¡Œç­¾åˆ°æ‰“å¡äº†
                        </div>
                        <div class="btn-group" style="justify-content: center;">
                            <button class="btn btn-secondary" onclick="registerAnother()">ç»§ç»­æ³¨å†Œå…¶ä»–å‘˜å·¥</button>
                            <button class="btn btn-primary" onclick="location.href='index.html'">å»ç­¾åˆ°æ‰“å¡</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæç¤ºä¿¡æ¯ -->
            <div>
                <div class="tips-card">
                    <h3>ğŸ’¡ æ‹ç…§æç¤º</h3>
                    <ul>
                        <li>ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…é€†å…‰</li>
                        <li>æ­£å¯¹æ‘„åƒå¤´ï¼Œéœ²å‡ºå®Œæ•´é¢éƒ¨</li>
                        <li>ä¸è¦ä½©æˆ´å¢¨é•œæˆ–é®æŒ¡é¢éƒ¨</li>
                        <li>ä¿æŒè‡ªç„¶è¡¨æƒ…</li>
                        <li>å»ºè®®æ‹æ‘„å¤šä¸ªè§’åº¦çš„ç…§ç‰‡</li>
                    </ul>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“Š æ³¨å†Œç»Ÿè®¡</h3>
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;" id="statTotal">0</div>
                            <div style="color: #999; font-size: 14px;">æ€»å‘˜å·¥æ•°</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: bold; color: #4caf50;" id="statRegistered">0</div>
                            <div style="color: #999; font-size: 14px;">å·²æ³¨å†Œäººè„¸</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: bold; color: #ff9800;" id="statPending">0</div>
                            <div style="color: #999; font-size: 14px;">å¾…æ³¨å†Œ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†...</div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script src="js/api.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let video = null;
        let canvas = null;
        let ctx = null;
        let stream = null;
        let employees = [];
        let selectedEmployee = null;
        let capturedPhotos = [];

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadEmployees();
            loadStatistics();
        });

        // åŠ è½½å‘˜å·¥åˆ—è¡¨
        async function loadEmployees() {
            try {
                const response = await api.getEmployees();
                if (response.success) {
                    employees = response.data.list || [];
                    renderEmployeeList(employees);
                } else {
                    showToast('åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥:', error);
                showToast('åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨', 'error');
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await api.getEmployees();
                if (response.success) {
                    const list = response.data.list || [];
                    const total = list.length;
                    const registered = list.filter(e => e.hasFace).length;
                    
                    document.getElementById('statTotal').textContent = total;
                    document.getElementById('statRegistered').textContent = registered;
                    document.getElementById('statPending').textContent = total - registered;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å‘˜å·¥åˆ—è¡¨
        function renderEmployeeList(list) {
            const container = document.getElementById('employeeList');
            
            if (list.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— å‘˜å·¥æ•°æ®</div>';
                return;
            }

            container.innerHTML = list.map(emp => `
                <div class="employee-option" onclick="selectEmployee('${emp.employeeId}', this)">
                    <div class="avatar">${emp.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${emp.name}</div>
                        <div class="dept">${emp.department || 'æœªè®¾ç½®éƒ¨é—¨'} Â· ${emp.employeeId}</div>
                    </div>
                    <div class="face-status ${emp.hasFace ? 'registered' : 'not-registered'}">
                        ${emp.hasFace ? 'âœ“ å·²æ³¨å†Œ' : 'â—‹ æœªæ³¨å†Œ'}
                    </div>
                </div>
            `).join('');
        }

        // æœç´¢å‘˜å·¥
        function filterEmployees() {
            const keyword = document.getElementById('searchEmployee').value.toLowerCase();
            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(keyword) || 
                emp.employeeId.toLowerCase().includes(keyword)
            );
            renderEmployeeList(filtered);
        }

        // é€‰æ‹©å‘˜å·¥
        function selectEmployee(employeeId, element) {
            selectedEmployee = employees.find(e => e.employeeId === employeeId);
            console.log('é€‰æ‹©å‘˜å·¥:', selectedEmployee); // è°ƒè¯•æ—¥å¿—
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.employee-option').forEach(el => {
                el.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }

            // æ¸…ç©ºæ–°å‘˜å·¥è¡¨å•
            document.getElementById('newEmployeeId').value = '';
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newDepartment').value = '';
            document.getElementById('newPosition').value = '';
        }

        // è¿›å…¥æ­¥éª¤2
        async function goToStep2() {
            console.log('=== goToStep2 å¼€å§‹ ===');
            console.log('selectedEmployee:', selectedEmployee);
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å‘˜å·¥æˆ–å¡«å†™äº†æ–°å‘˜å·¥ä¿¡æ¯
            const newIdElement = document.getElementById('newEmployeeId');
            const newNameElement = document.getElementById('newEmployeeName');
            
            console.log('newIdElement:', newIdElement);
            console.log('newNameElement:', newNameElement);
            
            const newId = newIdElement ? newIdElement.value.trim() : '';
            const newName = newNameElement ? newNameElement.value.trim() : '';
            
            console.log('è¡¨å•æ•°æ® - newId:', newId, 'newName:', newName);

            if (!selectedEmployee && (!newId || !newName)) {
                console.log('éªŒè¯å¤±è´¥ï¼šæ²¡æœ‰é€‰æ‹©å‘˜å·¥ä¸”è¡¨å•ä¸å®Œæ•´');
                showToast('è¯·é€‰æ‹©å‘˜å·¥æˆ–å¡«å†™æ–°å‘˜å·¥ä¿¡æ¯', 'warning');
                return;
            }
            
            console.log('éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ...');

            // å¦‚æœæ˜¯æ–°å‘˜å·¥ï¼Œå…ˆåˆ›å»º
            if (!selectedEmployee && newId && newName) {
                showLoading('æ­£åœ¨æ·»åŠ å‘˜å·¥...');
                try {
                    const response = await api.addEmployee({
                        employeeId: newId,
                        name: newName,
                        department: document.getElementById('newDepartment').value.trim(),
                        position: document.getElementById('newPosition').value.trim()
                    });
                    hideLoading();
                    console.log('addEmployee å“åº”:', response);

                    if (response.success) {
                        // å¦‚æœåç«¯è¿”å›äº†å‘˜å·¥æ•°æ®å°±ç”¨ï¼Œå¦åˆ™ç”¨è¡¨å•æ•°æ®
                        selectedEmployee = response.data || {
                            employeeId: newId,
                            name: newName,
                            department: document.getElementById('newDepartment').value.trim(),
                            position: document.getElementById('newPosition').value.trim()
                        };
                        console.log('æ·»åŠ æˆåŠŸï¼ŒselectedEmployee:', selectedEmployee);
                        showToast('å‘˜å·¥æ·»åŠ æˆåŠŸ', 'success');
                    } else {
                        // å¦‚æœæ˜¯å·¥å·å·²å­˜åœ¨ï¼Œå°è¯•æŸ¥æ‰¾å·²æœ‰å‘˜å·¥
                        if (response.message && response.message.includes('å·²å­˜åœ¨')) {
                            const existingEmp = employees.find(e => e.employeeId === newId);
                            if (existingEmp) {
                                selectedEmployee = existingEmp;
                                showToast('å‘˜å·¥å·²å­˜åœ¨ï¼Œå°†ä¸ºå…¶æ³¨å†Œäººè„¸', 'info');
                            } else {
                                showToast(response.message || 'æ·»åŠ å¤±è´¥', 'error');
                                return;
                            }
                        } else {
                            showToast(response.message || 'æ·»åŠ å¤±è´¥', 'error');
                            return;
                        }
                    }
                } catch (error) {
                    hideLoading();
                    console.error('æ·»åŠ å‘˜å·¥å¼‚å¸¸:', error);
                    showToast('æ·»åŠ å‘˜å·¥å¤±è´¥: ' + error.message, 'error');
                    return;
                }
            }

            // ç¡®ä¿ selectedEmployee å­˜åœ¨
            if (!selectedEmployee) {
                console.error('selectedEmployee ä¸ºç©ºï¼Œæ— æ³•ç»§ç»­');
                showToast('è¯·å…ˆé€‰æ‹©æˆ–æ·»åŠ å‘˜å·¥', 'error');
                return;
            }
            
            console.log('å‡†å¤‡è·³è½¬åˆ°æ­¥éª¤2ï¼Œå‘˜å·¥:', selectedEmployee);

            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            // åˆ‡æ¢å†…å®¹
            document.getElementById('stepContent1').style.display = 'none';
            document.getElementById('stepContent2').style.display = 'block';

            // æ˜¾ç¤ºå½“å‰å‘˜å·¥ä¿¡æ¯
            document.getElementById('currentEmployeeName').textContent = selectedEmployee.name;
            document.getElementById('currentEmployeeId').textContent = selectedEmployee.employeeId;

            console.log('é¡µé¢å·²åˆ‡æ¢åˆ°æ­¥éª¤2');

            // åˆå§‹åŒ–æ‘„åƒå¤´
            try {
                await initCamera();
                console.log('æ‘„åƒå¤´åˆå§‹åŒ–å®Œæˆ');
            } catch (e) {
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–å‡ºé”™:', e);
            }

            // é‡ç½®ç…§ç‰‡
            capturedPhotos = [];
            updatePhotosPreview();
            
            console.log('=== goToStep2 å®Œæˆ ===');
        }

        // è¿”å›æ­¥éª¤1
        function goToStep1() {
            // åœæ­¢æ‘„åƒå¤´
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active');

            // åˆ‡æ¢å†…å®¹
            document.getElementById('stepContent1').style.display = 'block';
            document.getElementById('stepContent2').style.display = 'none';

            // é‡ç½®
            selectedEmployee = null;
            capturedPhotos = [];
        }

        // åˆå§‹åŒ–æ‘„åƒå¤´
        async function initCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                video.srcObject = stream;
                updateCameraStatus(true, 'æ‘„åƒå¤´å°±ç»ª');
            } catch (error) {
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
                updateCameraStatus(false, 'æ‘„åƒå¤´ä¸å¯ç”¨');
                showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
            }
        }

        // æ›´æ–°æ‘„åƒå¤´çŠ¶æ€
        function updateCameraStatus(isOk, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            dot.className = isOk ? 'status-dot' : 'status-dot error';
            statusText.textContent = text;
        }

        // æ‹ç…§
        async function capturePhoto() {
            if (!stream) {
                showToast('æ‘„åƒå¤´æœªå°±ç»ª', 'error');
                return;
            }

            if (capturedPhotos.length >= 3) {
                showToast('å·²æ‹æ‘„3å¼ ç…§ç‰‡', 'warning');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            // æ£€æµ‹äººè„¸
            showLoading('æ­£åœ¨æ£€æµ‹äººè„¸...');
            try {
                const response = await api.detectFace(imageData);
                hideLoading();

                if (response.success && response.data.faceDetected) {
                    capturedPhotos.push({
                        image: imageData,
                        url: response.data.imageUrl
                    });
                    updatePhotosPreview();
                    showToast(`å·²æ‹æ‘„ ${capturedPhotos.length}/3 å¼ ç…§ç‰‡`, 'success');
                } else {
                    showToast('æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·è°ƒæ•´ä½ç½®é‡è¯•', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('æ£€æµ‹å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç…§ç‰‡é¢„è§ˆ
        function updatePhotosPreview() {
            const container = document.getElementById('photosPreview');
            let html = '';

            for (let i = 0; i < 3; i++) {
                if (capturedPhotos[i]) {
                    html += `
                        <div class="photo-item">
                            <img src="${capturedPhotos[i].image}" alt="ç…§ç‰‡${i+1}">
                            <button class="remove-btn" onclick="removePhoto(${i})">Ã—</button>
                        </div>
                    `;
                } else {
                    html += '<div class="photo-placeholder">+</div>';
                }
            }

            container.innerHTML = html;

            // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
            document.getElementById('btnSubmit').disabled = capturedPhotos.length < 1;
        }

        // åˆ é™¤ç…§ç‰‡
        function removePhoto(index) {
            capturedPhotos.splice(index, 1);
            updatePhotosPreview();
        }

        // æäº¤æ³¨å†Œ
        async function submitRegister() {
            if (capturedPhotos.length === 0) {
                showToast('è¯·è‡³å°‘æ‹æ‘„ä¸€å¼ ç…§ç‰‡', 'warning');
                return;
            }

            showLoading('æ­£åœ¨æ³¨å†Œäººè„¸...');

            try {
                const response = await api.registerFace({
                    employeeId: selectedEmployee.employeeId,
                    imageUrls: capturedPhotos.map(p => p.url || p.image)
                });
                hideLoading();

                if (response.success) {
                    // è¿›å…¥æ­¥éª¤3
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('active');

                    document.getElementById('stepContent2').style.display = 'none';
                    document.getElementById('stepContent3').style.display = 'block';

                    document.getElementById('completeName').textContent = selectedEmployee.name;

                    // åœæ­¢æ‘„åƒå¤´
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }

                    // åˆ·æ–°ç»Ÿè®¡
                    loadStatistics();
                    loadEmployees();
                } else {
                    showToast(response.message, 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç»§ç»­æ³¨å†Œå…¶ä»–å‘˜å·¥
        function registerAnother() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step3').classList.remove('active');

            document.getElementById('stepContent1').style.display = 'block';
            document.getElementById('stepContent2').style.display = 'none';
            document.getElementById('stepContent3').style.display = 'none';

            selectedEmployee = null;
            capturedPhotos = [];

            // æ¸…ç©ºè¡¨å•
            document.getElementById('searchEmployee').value = '';
            document.getElementById('newEmployeeId').value = '';
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newDepartment').value = '';
            document.getElementById('newPosition').value = '';

            // åˆ·æ–°å‘˜å·¥åˆ—è¡¨
            loadEmployees();
        }

        // æ˜¾ç¤ºåŠ è½½
        function showLoading(text = 'åŠ è½½ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').classList.add('show');
        }

        // éšè—åŠ è½½
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
